<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACCME Provider Directory Scraper</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f4f8; color: #1a202c; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
  .container { max-width: 720px; width: 100%; padding: 2rem; }
  .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 2.5rem; }
  h1 { font-size: 1.6rem; margin-bottom: 0.3rem; color: #2f5496; }
  .subtitle { color: #718096; font-size: 0.95rem; margin-bottom: 2rem; }
  .config { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
  .config label { font-size: 0.85rem; font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.3rem; }
  .config input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.9rem; }
  .config input:focus { outline: none; border-color: #2f5496; box-shadow: 0 0 0 3px rgba(47,84,150,0.15); }
  .spanish-cities { grid-column: 1 / -1; }
  .spanish-cities input { font-size: 0.85rem; }
  button { background: #2f5496; color: #fff; border: none; padding: 0.85rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; transition: background 0.2s; }
  button:hover:not(:disabled) { background: #1e3a6e; }
  button:disabled { background: #a0aec0; cursor: not-allowed; }
  .progress { margin-top: 1.5rem; display: none; }
  .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 0.75rem; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #2f5496, #4c8bf5); border-radius: 4px; transition: width 0.3s; width: 0%; }
  .status { font-size: 0.9rem; color: #4a5568; min-height: 1.4rem; }
  .stats { margin-top: 1.5rem; display: none; background: #f7fafc; border-radius: 8px; padding: 1.25rem; }
  .stats h3 { font-size: 0.95rem; margin-bottom: 0.75rem; color: #2d3748; }
  .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
  .stat { text-align: center; }
  .stat-value { font-size: 1.5rem; font-weight: 700; color: #2f5496; }
  .stat-label { font-size: 0.75rem; color: #718096; margin-top: 0.15rem; }
  .tier-row { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .tier-badge { flex: 1; text-align: center; padding: 0.5rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
  .t1 { background: #c6efce; color: #1a5928; }
  .t2 { background: #ffeb9c; color: #7c5e00; }
  .t3 { background: #ffc7ce; color: #9c2020; }
  .error { color: #e53e3e; margin-top: 1rem; font-size: 0.9rem; display: none; }
  .footer { text-align: center; margin-top: 1.5rem; font-size: 0.8rem; color: #a0aec0; }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>ACCME Provider Directory Scraper</h1>
    <p class="subtitle">Fetch all accredited CME providers and download as a structured Excel workbook.</p>

    <div class="config">
      <div>
        <label for="tierHigh">Tier 1: Activities &ge;</label>
        <input type="number" id="tierHigh" value="100" min="1">
      </div>
      <div>
        <label for="tierMid">Tier 2: Activities &ge;</label>
        <input type="number" id="tierMid" value="20" min="1">
      </div>
      <div class="spanish-cities">
        <label for="spanishCities">Spanish-Market Cities (comma-separated)</label>
        <input type="text" id="spanishCities" value="miami, san antonio, los angeles, phoenix, el paso, tucson, albuquerque">
      </div>
    </div>

    <button id="startBtn" onclick="run()">Scrape &amp; Download Excel</button>

    <div class="progress" id="progress">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="status" id="status">Initializing...</div>
    </div>

    <div class="error" id="error"></div>

    <div class="stats" id="stats">
      <h3>Results</h3>
      <div class="stat-grid">
        <div class="stat"><div class="stat-value" id="totalCount">0</div><div class="stat-label">Total Providers</div></div>
        <div class="stat"><div class="stat-value" id="spanishCount">0</div><div class="stat-label">Spanish Market</div></div>
        <div class="stat"><div class="stat-value" id="highVolCount">0</div><div class="stat-label">High Volume</div></div>
      </div>
      <div class="tier-row">
        <div class="tier-badge t1">Tier 1: <span id="t1Count">0</span></div>
        <div class="tier-badge t2">Tier 2: <span id="t2Count">0</span></div>
        <div class="tier-badge t3">Tier 3: <span id="t3Count">0</span></div>
      </div>
    </div>
  </div>
  <div class="footer">Data sourced from accme.org WP REST API &middot; Runs entirely in your browser</div>
</div>

<script>
const API_BASE = 'https://accme.org/wp-json/wp/v2';

/* ── Taxonomy slug → human-readable maps ── */
const ACC_TYPE_MAP = {
  'accme_accredited_provider': 'ACCME Accredited',
  'jointly_accredited_provider': 'Jointly Accredited',
  'state_accredited_provider': 'State Accredited'
};
const ACC_STATUS_MAP = {
  'accreditation_with_commendation': 'Accreditation with Commendation',
  'accreditation': 'Accredited',
  'provisional_accreditation': 'Provisional',
  'probation': 'Probation',
  'joint_accreditation': 'Joint Accreditation',
  'joint_accreditation_with_commendation': 'Joint with Commendation'
};

/* ── UI helpers ── */
function setProgress(pct, msg) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('status').textContent = msg;
}
function showError(msg) {
  const el = document.getElementById('error');
  el.textContent = msg;
  el.style.display = 'block';
}

/* ── Fetch all terms for a WP taxonomy (id → name map) ── */
async function fetchTermMap(taxonomy, useNameField = false) {
  const map = {};
  let page = 1;
  while (true) {
    const resp = await fetch(`${API_BASE}/${taxonomy}?per_page=100&page=${page}`);
    if (!resp.ok) break;
    const terms = await resp.json();
    if (!terms.length) break;
    terms.forEach(t => { map[t.id] = useNameField ? t.name : t.slug; });
    page++;
  }
  return map;
}

/* ── Paginated provider fetch ── */
async function fetchProviders(onProgress) {
  let page = 1, all = [], total = null;
  while (true) {
    const resp = await fetch(`${API_BASE}/provider?per_page=100&page=${page}`);
    if (!resp.ok) break;
    if (total === null) total = parseInt(resp.headers.get('X-WP-Total')) || 1500;
    const data = await resp.json();
    if (!data.length) break;
    all = all.concat(data);
    onProgress(Math.min(90, 10 + Math.round((all.length / total) * 70)),
               `Fetched ${all.length} of ~${total} providers (page ${page})...`);
    page++;
    if (all.length >= total) break;
  }
  return all;
}

function decodeHtml(str) {
  const txt = document.createElement('textarea');
  txt.innerHTML = str;
  return txt.value;
}

/* ── Process raw API records into flat objects ── */
function processProviders(raw, tax, config) {
  const { statusTerms, typeTerms, formatTerms, jpTerms, cityTerms, stateTerms, countryTerms } = tax;

  return raw.map(p => {
    const name = decodeHtml(p.title?.rendered || '');
    const acf = p.acf || {};
    const activities = parseInt(acf.provider_number_activities) || 0;

    // Resolve taxonomy IDs → human labels
    const typeSlugs = (p.provider_type || []).map(id => typeTerms[id]).filter(Boolean);
    const accType = typeSlugs.map(s => ACC_TYPE_MAP[s] || 'Other').join(', ') || 'Other';

    const statusSlugs = (p.accreditation_status || []).map(id => statusTerms[id]).filter(Boolean);
    const accStatus = statusSlugs.map(s => ACC_STATUS_MAP[s] || 'Other').join(', ') || 'Other';

    const formats = (p.activity_format || []).map(id => {
      const slug = formatTerms[id] || '';
      return slug.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }).filter(Boolean).join(', ');

    const jpSlugs = (p.joint_providership || []).map(id => jpTerms[id]);
    const jp = jpSlugs.includes('yes') ? 'Yes' : 'No';

    // city, state, country are taxonomy ID arrays
    const city = (p.city || []).map(id => cityTerms[id] || '').filter(Boolean).join(', ');
    const state = (p.provider_state || []).map(id => stateTerms[id] || '').filter(Boolean).join(', ');
    const country = (p.provider_country || []).map(id => countryTerms[id] || '').filter(Boolean).join(', ') || 'USA';

    // Combine address lines
    const addr1 = acf.provider_address_1 || '';
    const addr2 = acf.provider_address_2 || '';
    const address = [addr1, addr2].filter(Boolean).join(', ');

    const cityLower = city.toLowerCase();
    const hasCommendation = accStatus.includes('Commendation');
    const isSpanish = state === 'PR' || config.spanishCities.includes(cityLower);

    let tier = 3;
    if (activities >= config.tierHigh || hasCommendation || state === 'PR' || config.spanishCities.includes(cityLower)) {
      tier = 1;
    } else if (activities >= config.tierMid || accType.includes('ACCME Accredited') ||
               ['Medical Society','Medical Association','Academy','College'].some(kw => name.includes(kw))) {
      tier = 2;
    }

    return {
      'Provider Name': name,
      'City': city,
      'State': state,
      'Country': country,
      'Website': acf.provider_website || '',
      'Accreditation Type': accType,
      'Accreditation Status': accStatus,
      'Joint Providership': jp,
      'Activities/Year': activities,
      'Contact Name': acf.provider_contact_name || '',
      'Contact Phone': acf.provider_contact_number || '',
      'Address': address,
      'ZIP': acf.provider_zip || '',
      'Activity Formats': formats,
      'Accredited By': acf.provider_accredited_by || '',
      'Provider ID': acf.provider_id || p.id,
      'Priority Tier': tier,
      'Spanish Market': isSpanish ? 'Yes' : 'No',
      'High Volume': activities >= config.tierHigh ? 'Yes' : 'No',
      'Commendation Status': hasCommendation ? 'Yes' : 'No',
      'Notes': ''
    };
  }).sort((a, b) => a['Priority Tier'] - b['Priority Tier'] || b['Activities/Year'] - a['Activities/Year']);
}

/* ── Build and download Excel ── */
function buildExcel(records) {
  const wb = XLSX.utils.book_new();

  function addSheet(name, data) {
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [
      {wch:45},{wch:18},{wch:6},{wch:8},{wch:30},{wch:25},{wch:30},{wch:10},
      {wch:12},{wch:25},{wch:18},{wch:40},{wch:12},{wch:35},{wch:30},{wch:10},
      {wch:10},{wch:14},{wch:11},{wch:18},{wch:20}
    ];
    ws['!freeze'] = { xSplit: 0, ySplit: 1 };
    if (data.length > 0) {
      const cols = Object.keys(data[0]);
      ws['!autofilter'] = { ref: XLSX.utils.encode_range({s:{r:0,c:0}, e:{r:data.length, c:cols.length-1}}) };
    }
    XLSX.utils.book_append_sheet(wb, ws, name);
  }

  addSheet('All Providers', records);
  addSheet('Tier 1 Targets', records.filter(r => r['Priority Tier'] === 1));
  addSheet('Spanish Market Focus', records.filter(r => r['Spanish Market'] === 'Yes'));
  addSheet('High Volume', records.filter(r => r['High Volume'] === 'Yes')
    .sort((a,b) => b['Activities/Year'] - a['Activities/Year']));

  const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
  XLSX.writeFile(wb, `accme_providers_${today}.xlsx`);
}

/* ── Main orchestrator ── */
async function run() {
  const btn = document.getElementById('startBtn');
  const progressEl = document.getElementById('progress');
  const statsEl = document.getElementById('stats');
  const errorEl = document.getElementById('error');

  btn.disabled = true;
  progressEl.style.display = 'block';
  statsEl.style.display = 'none';
  errorEl.style.display = 'none';

  const config = {
    tierHigh: parseInt(document.getElementById('tierHigh').value) || 100,
    tierMid: parseInt(document.getElementById('tierMid').value) || 20,
    spanishCities: document.getElementById('spanishCities').value
      .split(',').map(s => s.trim().toLowerCase()).filter(Boolean)
  };

  try {
    // Step 1: Fetch all taxonomy lookups in parallel
    setProgress(2, 'Loading taxonomy terms (status, type, format, cities, states)...');
    const [statusTerms, typeTerms, formatTerms, jpTerms, cityTerms, stateTerms, countryTerms] =
      await Promise.all([
        fetchTermMap('accreditation_status'),
        fetchTermMap('provider_type'),
        fetchTermMap('activity_format'),
        fetchTermMap('joint_providership'),
        fetchTermMap('city', true),            // id → city name
        fetchTermMap('provider_state', true),   // id → state abbreviation
        fetchTermMap('provider_country', true)  // id → country code
      ]);
    const tax = { statusTerms, typeTerms, formatTerms, jpTerms, cityTerms, stateTerms, countryTerms };

    // Step 2: Fetch all providers
    setProgress(10, 'Fetching providers...');
    const raw = await fetchProviders(setProgress);

    // Step 3: Process
    setProgress(85, `Processing ${raw.length} providers...`);
    const records = processProviders(raw, tax, config);

    // Step 4: Build Excel
    setProgress(92, 'Building Excel workbook...');
    buildExcel(records);
    setProgress(100, `Done! Downloaded ${records.length} providers.`);

    // Show stats
    const t1 = records.filter(r => r['Priority Tier'] === 1).length;
    const t2 = records.filter(r => r['Priority Tier'] === 2).length;
    const t3 = records.filter(r => r['Priority Tier'] === 3).length;
    document.getElementById('totalCount').textContent = records.length;
    document.getElementById('spanishCount').textContent = records.filter(r => r['Spanish Market'] === 'Yes').length;
    document.getElementById('highVolCount').textContent = records.filter(r => r['High Volume'] === 'Yes').length;
    document.getElementById('t1Count').textContent = t1;
    document.getElementById('t2Count').textContent = t2;
    document.getElementById('t3Count').textContent = t3;
    statsEl.style.display = 'block';

  } catch (err) {
    showError('Error: ' + err.message + '. Make sure you can reach accme.org (try opening accme.org in another tab first).');
    console.error(err);
  }

  btn.disabled = false;
}
</script>
</body>
</html>
